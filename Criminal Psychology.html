<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criminal Psychology Protocol: Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap');

        :root {
            --bg-dark: #10101c; /* Even darker base */
            --bg-medium: #1c1c2f;
            --panel-bg: #22223a; /* Slightly lighter for panel */
            --text-light: #e0e0e0;
            --text-medium: #a0a0c0;
            --accent-blue: #00bcd4; /* Cyan */
            --accent-green: #2ecc71;
            --highlight-red: #e74c3c; /* Still a strong red for danger/manipulation */
            --glow-red: #ff0055;
            --glow-blue: #00ffff; /* Neon Blue */
            --glow-purple: #ff00ff; /* Magenta */
            --border-color: #3f3f5a;
            --box-bg-normal: #333355;
            --box-bg-highlight: #444466;
            --grid-line-color: rgba(63, 63, 90, 0.3); /* Subtle grid */
        }

        body {
            font-family: 'Share Tech Mono', monospace, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .dashboard-header {
            width: 100%;
            max-width: 1200px; /* Constrain header width */
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--glow-blue);
            text-shadow: 0 0 10px var(--glow-blue), 0 0 20px var(--glow-blue);
            margin-bottom: 5px;
            letter-spacing: 3px;
            font-size: 2.5em;
        }
        p.subtitle {
            font-size: 0.9em;
            color: var(--text-medium);
            margin-bottom: 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .dashboard-main {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Flowchart left (larger), Profiler Notes right */
            gap: 20px;
            width: 100%;
            max-width: 1200px; /* Dashboard overall width */
            margin-bottom: 20px;
        }

        .dashboard-panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
            padding: 15px;
            box-sizing: border-box;
            position: relative; /* For nested absolute elements */
        }

        #flowchart-panel {
            min-height: 750px; /* Fixed height for flowchart area */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #profiler-notes-panel {
            min-height: 750px; /* Match flowchart height */
            display: flex;
            flex-direction: column;
            font-size: 0.9em;
        }
        #profiler-notes-panel h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-blue);
            text-shadow: 0 0 5px var(--accent-blue);
            margin-top: 0;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--border-color);
        }
        #profiler-notes-text {
            color: var(--text-light);
            line-height: 1.6;
        }


        #flowchart-container {
            position: relative; /* All boxes are absolutely positioned within this */
            width: 880px; /* Adjusted to fit the panel better */
            height: 710px; /* Adjusted height */
            /* Removed border, shadow, background from container itself as panel handles it */
            display: block; /* No flex for the container, let absolute children arrange */
        }
        .flow-box {
            position: absolute;
            width: 250px;
            height: 150px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.9em;
            color: var(--text-light);
            box-sizing: border-box;
            transition: all 0.4s ease-in-out, box-shadow 0.6s ease-in-out;
            border: 2px solid var(--border-color);
            background-color: var(--box-bg-normal);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
            transform-style: preserve-3d;
        }
        .flow-box.highlight {
            border-color: var(--glow-red);
            box-shadow: 0 0 15px var(--glow-red), 0 0 30px rgba(255, 0, 85, 0.4);
            transform: scale(1.05) rotateY(5deg);
            z-index: 10;
            background-color: var(--box-bg-highlight);
        }

        /* Positioning - unchanged, relative to #flowchart-container */
        #box-1 { top: 10px; left: 10px; }
        #box-2 { top: 10px; left: 310px; }
        #box-3 { top: 10px; left: 610px; }

        #box-4 { top: 240px; left: 10px; }
        #box-5 { top: 240px; left: 310px; }
        #box-6 { top: 240px; left: 610px; }

        #box-7 { top: 470px; left: 10px; }
        #box-8 { top: 470px; left: 310px; }
        #box-9 { top: 470px; left: 610px; }

        /* SVG Arrows */
        svg.arrows {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .flow-arrow {
            stroke: var(--text-medium);
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
            transition: stroke 0.4s ease-in-out, stroke-width 0.4s ease-in-out, opacity 0.4s ease-in-out;
            opacity: 0.5;
        }
        .flow-arrow.highlight {
            stroke: var(--glow-red);
            stroke-width: 4;
            opacity: 1;
            z-index: 5;
            filter: drop-shadow(0 0 5px var(--glow-red));
        }
        #arrowhead polygon { fill: var(--text-medium); transition: fill 0.4s ease-in-out; }

        /* Icons inside boxes */
        .box-icon {
            margin-bottom: 5px;
            height: 60px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .box-icon svg {
            height: 100%;
            width: auto;
            max-width: 80%;
        }
        .box-icon svg path, .box-icon svg circle, .box-icon svg rect, .box-icon svg polygon, .box-icon svg line {
            fill: var(--text-medium);
            stroke: none;
            transition: fill 0.4s ease-in-out, stroke 0.4s ease-in-out;
            transform-origin: center center;
            vector-effect: non-scaling-stroke;
        }
        .box-icon svg .stroke-element {
            stroke: var(--text-medium);
            stroke-width: 2px;
            fill: none;
            transition: stroke 0.4s ease-in-out;
        }
        
        .box-text, .small-text {
            font-weight: bold;
            margin-top: 5px;
            transition: color 0.4s ease-in-out;
            letter-spacing: 0.5px;
        }
        .small-text {
            font-size: 0.8em;
            color: var(--text-medium);
            font-weight: normal;
        }

        /* Highlight styles for contents of the highlighted box */
        .flow-box.highlight .box-icon svg path,
        .flow-box.highlight .box-icon svg circle,
        .flow-box.highlight .box-icon svg rect,
        .flow-box.highlight .box-icon svg polygon,
        .flow-box.highlight .box-icon svg line {
            fill: var(--glow-blue);
        }
        .flow-box.highlight .box-icon svg .stroke-element {
            stroke: var(--glow-blue);
        }
        .flow-box.highlight .box-text {
            color: var(--glow-blue);
            text-shadow: 0 0 5px var(--glow-blue);
        }
        .flow-box.highlight .small-text {
            color: var(--accent-blue);
        }

        /* ANIMATIONS */
        .box-icon svg * { animation: none !important; } /* Reset all animations */

        /* 1. Motive / Intent: Brain pulse, question mark */
        @keyframes brainPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes qMarkFade {
            0% { opacity: 0; transform: translateY(5px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-5px); }
        }
        .flow-box.highlight #brain-icon {
            animation: brainPulse 1.5s ease-in-out infinite alternate;
        }
        .flow-box.highlight #q-mark {
            animation: qMarkFade 2s ease-in-out infinite;
        }
        #q-mark { opacity: 0; }

        /* 2. Victimology / Opportunity: Target scope scan */
        @keyframes scanLine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .flow-box.highlight #scan-line {
            animation: scanLine 1.5s linear infinite;
        }
        #scan-line { opacity: 0; }

        /* 3. Planning / Method: Blueprint shimmer */
        @keyframes blueprintShimmer {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .flow-box.highlight #blueprint-detail {
            animation: blueprintShimmer 2s ease-in-out infinite;
        }

        /* 4. Psychological State: Distorted face */
        @keyframes faceDistort {
            0%, 100% { transform: scaleX(1); }
            50% { transform: scaleX(0.95) scaleY(1.05); }
        }
        @keyframes eyeGlow {
            0%, 100% { fill: var(--glow-blue); }
            50% { fill: var(--glow-red); }
        }
        .flow-box.highlight #distorted-face {
            animation: faceDistort 1.8s ease-in-out infinite alternate;
        }
        .flow-box.highlight #distorted-eye-left, .flow-box.highlight #distorted-eye-right {
            animation: eyeGlow 2s ease-in-out infinite alternate;
        }

        /* 5. Execution Pre-Meditation: Countdown */
        @keyframes countdown {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-5px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .flow-box.highlight #countdown-digit {
            animation: countdown 1s steps(1) infinite;
        }

        /* 6. Act / Offense: Fragmented action */
        @keyframes fragmentAppear {
            0% { opacity: 0; transform: translateY(10px) scale(0.8); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes actionPulse {
            0%, 100% { filter: drop-shadow(0 0 2px var(--glow-red)); }
            50% { filter: drop-shadow(0 0 5px var(--glow-red)); }
        }
        .flow-box.highlight #fragment-1 { animation: fragmentAppear 0.5s ease-out forwards; }
        .flow-box.highlight #fragment-2 { animation: fragmentAppear 0.5s 0.2s ease-out forwards; }
        .flow-box.highlight #fragment-3 { animation: fragmentAppear 0.5s 0.4s ease-out forwards; }
        .flow-box.highlight #fragment-group { animation: actionPulse 1.2s ease-in-out infinite alternate 0.5s; }
        #fragment-1, #fragment-2, #fragment-3 { opacity: 0; }

        /* 7. Aftermath / Cover-Up: Trail fade */
        @keyframes trailFade {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: 100; }
        }
        .flow-box.highlight #trail-path {
            stroke-dasharray: 20 20;
            animation: trailFade 2s linear infinite;
        }

        /* 8. Investigation / Consequence: Eye scan, data fragments */
        @keyframes dataFragmentFloat {
            0%, 100% { transform: translateY(0); opacity: 0.8; }
            50% { transform: translateY(-3px); opacity: 1; }
        }
        .flow-box.highlight #evidence-eye {
            animation: brainPulse 1.8s ease-in-out infinite alternate;
        }
        .flow-box.highlight #data-fragment-1 { animation: dataFragmentFloat 1.5s ease-in-out infinite alternate; }
        .flow-box.highlight #data-fragment-2 { animation: dataFragmentFloat 1.5s 0.3s ease-in-out infinite alternate; }
        #data-fragment-1, #data-fragment-2 { opacity: 0; }

        /* 9. Resolution / Fate: Scales of justice or jail bars */
        @keyframes scaleBalance {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(10deg); }
        }
        @keyframes jailBarsGlow {
            0%, 100% { filter: drop-shadow(0 0 2px var(--glow-red)); }
            50% { filter: drop-shadow(0 0 5px var(--glow-red)); }
        }
        .flow-box.highlight #scales-base { animation: scaleBalance 2s ease-in-out infinite alternate; }
        .flow-box.highlight #jail-bar-1 { animation: jailBarsGlow 1s ease-in-out infinite alternate; }
        .flow-box.highlight #jail-bar-2 { animation: jailBarsGlow 1s 0.2s ease-in-out infinite alternate; }


        /* Controls */
        .dashboard-controls {
            display: flex;
            align-items: center;
            justify-content: center; /* Center controls */
            gap: 20px;
            margin-top: 0; /* Already margin on dashboard-main */
            width: 100%;
            max-width: 1200px;
            background-color: var(--panel-bg);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            border: 1px solid var(--border-color);
        }
        button {
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: var(--accent-blue);
            color: var(--bg-dark);
            font-weight: bold;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        button:hover:not(:disabled) {
            background-color: var(--glow-blue);
            transform: translateY(-1px);
            box-shadow: 0 0 8px var(--glow-blue);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        button:disabled {
            background-color: var(--border-color);
            color: var(--text-medium);
            cursor: not-allowed;
            box-shadow: none;
        }
        #currentStepText {
            color: var(--text-light);
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="dashboard-header">
        <h1>CRIMINAL PSYCHOLOGY PROTOCOL</h1>
        <p class="subtitle">PROFILING THE DEVIANT MIND: ANALYZING BEHAVIORAL PATTERNS</p>
    </div>

    <div class="dashboard-main">
        <div id="flowchart-panel" class="dashboard-panel">
            <div id="flowchart-container">
                <!-- SVG for arrows -->
                <svg class="arrows" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" class="arrowhead-polygon" style="fill:var(--text-medium);" />
                        </marker>
                    </defs>
                    <!-- Top row horizontal arrows -->
                    <line id="arrow-1-2" class="flow-arrow" x1="270" y1="85" x2="310" y2="85" />
                    <line id="arrow-2-3" class="flow-arrow" x1="570" y1="85" x2="610" y2="85" />
                    
                    <!-- Mid row horizontal arrows -->
                    <line id="arrow-4-5" class="flow-arrow" x1="270" y1="315" x2="310" y2="315" />
                    <line id="arrow-5-6" class="flow-arrow" x1="570" y1="315" x2="610" y2="315" />

                    <!-- Bottom row horizontal arrows -->
                    <line id="arrow-7-8" class="flow-arrow" x1="270" y1="545" x2="310" y2="545" />
                    <line id="arrow-8-9" class="flow-arrow" x1="570" y1="545" x2="610" y2="545" />

                    <!-- Vertical arrows (connecting main column flow) -->
                    <line id="arrow-3-6" class="flow-arrow" x1="735" y1="160" x2="735" y2="240" />
                    <line id="arrow-6-9" class="flow-arrow" x1="735" y1="390" x2="735" y2="470" />
                </svg>

                <!-- Flowchart Boxes -->
                <div id="box-1" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <path id="brain-icon" d="M50 15 C30 15, 20 30, 20 50 C20 70, 30 85, 50 85 C70 85, 80 70, 80 50 C80 30, 70 15, 50 15 Z M50 20 A30 30 0 0 1 50 80 M50 20 A30 30 0 0 0 50 80" class="stroke-element" fill="#2a2a4a"/>
                            <text id="q-mark" x="50" y="55" font-size="30" text-anchor="middle" fill="var(--glow-red)">?</text>
                        </svg>
                    </div>
                    <div class="box-text">MOTIVE / INTENT</div>
                </div>

                <div id="box-2" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <rect x="20" y="20" width="60" height="60" fill="#2a2a4a" class="stroke-element"/>
                            <path d="M20 20 L80 80 M80 20 L20 80" class="stroke-element"/>
                            <circle cx="50" cy="50" r="15" class="stroke-element"/>
                            <rect id="scan-line" x="20" y="45" width="60" height="10" fill="var(--glow-blue)" opacity="0"/>
                        </svg>
                    </div>
                    <div class="box-text">VICTIMOLOGY / OPPORTUNITY</div>
                    <div class="small-text">[TARGET ACQUISITION]</div>
                </div>

                <div id="box-3" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <rect x="20" y="20" width="60" height="60" fill="#2a2a4a" class="stroke-element"/>
                            <path id="blueprint-detail" d="M25 25 L75 25 L75 75 L25 75 Z M30 30 L40 30 L40 40 L30 40 Z M60 60 L70 60 L70 70 L60 70 Z" class="stroke-element" fill="none"/>
                            <text x="50" y="55" font-size="10" text-anchor="middle" fill="#ccc">PLAN.V0.1</text>
                        </svg>
                    </div>
                    <div class="box-text">PLANNING / METHOD</div>
                </div>

                <div id="box-4" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="35" fill="#2a2a4a"/>
                            <path id="distorted-face" d="M50 30 C35 30, 30 40, 30 50 C30 60, 35 70, 50 70 C65 70, 70 60, 70 50 C70 40, 65 30, 50 30 Z" class="stroke-element"/>
                            <circle id="distorted-eye-left" cx="40" cy="45" r="5"/>
                            <circle id="distorted-eye-right" cx="60" cy="45" r="5"/>
                            <path d="M45 60 Q50 65 55 60" class="stroke-element"/>
                        </svg>
                    </div>
                    <div class="box-text">PSYCHOLOGICAL STATE</div>
                    <div class="small-text">[PERPETRATOR MINDSET]</div>
                </div>

                <div id="box-5" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <rect x="30" y="30" width="40" height="40" fill="#2a2a4a" class="stroke-element"/>
                            <text id="countdown-digit" x="50" y="60" font-size="40" text-anchor="middle" fill="var(--glow-red)">3</text>
                        </svg>
                    </div>
                    <div class="box-text">EXECUTION PRE-MEDITATION</div>
                    <div class="small-text">[PRE-OFFENSE RITUALS]</div>
                </div>

                <div id="box-6" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <g id="fragment-group">
                                <rect id="fragment-1" x="20" y="20" width="25" height="25" fill="#2a2a4a"/>
                                <rect id="fragment-2" x="55" y="30" width="20" height="20" fill="#2a2a4a"/>
                                <rect id="fragment-3" x="30" y="60" width="30" height="20" fill="#2a2a4a"/>
                            </g>
                        </svg>
                    </div>
                    <div class="box-text">ACT / OFFENSE</div>
                    <div class="small-text">[CRIME EXECUTION]</div>
                </div>

                <div id="box-7" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="30" fill="#2a2a4a" class="stroke-element"/>
                            <path id="trail-path" d="M30 40 Q50 20 70 40 Q50 80 30 60 Z" class="stroke-element" stroke-width="3"/>
                            <circle cx="70" cy="40" r="8" fill="var(--glow-red)"/>
                        </svg>
                    </div>
                    <div class="box-text">AFTERMATH / COVER-UP</div>
                </div>

                <div id="box-8" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <path d="M50 80 C20 80, 5 50, 50 20 C95 50, 80 80, 50 80 Z" class="stroke-element" fill="#2a2a4a"/>
                            <path d="M50 25 C70 25, 80 40, 80 50 C80 60, 70 75, 50 75 C30 75, 20 60, 20 50 C20 40, 30 25, 50 25 Z" class="stroke-element" id="evidence-eye"/>
                            <circle cx="50" cy="50" r="10"/>
                            <rect id="data-fragment-1" x="20" y="35" width="10" height="5" fill="var(--glow-blue)" opacity="0"/>
                            <rect id="data-fragment-2" x="70" y="60" width="10" height="5" fill="var(--glow-red)" opacity="0"/>
                        </svg>
                    </div>
                    <div class="box-text">INVESTIGATION / CONSEQUENCE</div>
                    <div class="small-text">[EVIDENCE MATRIX]</div>
                </div>

                <div id="box-9" class="flow-box">
                    <div class="box-icon">
                        <svg viewBox="0 0 100 100">
                            <g id="scales-base" transform-origin="50 50">
                                <rect x="45" y="60" width="10" height="20" fill="#2a2a4a"/>
                                <line x1="20" y1="60" x2="80" y2="60" class="stroke-element" stroke-width="3"/>
                                <circle cx="20" cy="50" r="10" fill="#2a2a4a"/>
                                <circle cx="80" cy="50" r="10" fill="#2a2a4a"/>
                            </g>
                            <rect id="jail-bar-1" x="40" y="10" width="5" height="30" fill="var(--glow-blue)"/>
                            <rect id="jail-bar-2" x="55" y="10" width="5" height="30" fill="var(--glow-blue)"/>
                        </svg>
                    </div>
                    <div class="box-text">RESOLUTION / FATE</div>
                </div>
            </div>
        </div>

        <div id="profiler-notes-panel" class="dashboard-panel">
            <h2>PROFILER OBSERVATIONS</h2>
            <div id="profiler-notes-text">
                <p>Welcome to the Criminal Psychology Protocol Dashboard. Utilize the navigation controls below to step through the stages of criminal behavior and profiling. Each step will update this panel with detailed insights.</p>
                <p>Click "Next Step" to begin.</p>
            </div>
        </div>
    </div>

    <div class="dashboard-controls">
        <button id="prevBtn" disabled>PREVIOUS STAGE</button>
        <button id="nextBtn">NEXT STAGE</button>
        <p id="currentStepText">STAGE <span id="currentStepNumber">0</span> OF <span id="totalStepsNumber"></span></p>
    </div>

    <script>
        const flowchartBoxes = [
            null, // Step 0 is just initial state, no box highlighted
            { id: 'box-1', arrow: null, description: '<h2>STAGE 1: MOTIVE / INTENT</h2><p><strong>ANALYSIS:</strong> This initial stage focuses on the psychological drives behind criminal behavior. It explores the "why" – financial gain, power, revenge, psychological gratification, or ideological conviction.</p><p><strong>INDICATORS:</strong> Personal grievances, financial distress, fantasies of violence or control, external pressures, or a deep-seated desire for recognition.</p>' },
            { id: 'box-2', arrow: 'arrow-1-2', description: '<h2>STAGE 2: VICTIMOLOGY / OPPORTUNITY</h2><p><strong>ANALYSIS:</strong> The perpetrator identifies and selects a target. This involves assessing vulnerabilities, accessibility, and the likelihood of successful execution without immediate apprehension.</p><p><strong>INDICATORS:</strong> Routine observation of potential victims, digital stalking, proximity, perceived helplessness of the target, and environmental factors (e.g., poor security, isolation).</p>' },
            { id: 'box-3', arrow: 'arrow-2-3', description: '<h2>STAGE 3: PLANNING / METHOD</h2><p><strong>ANALYSIS:</strong> Development of the operational blueprint for the crime. This includes choosing methods, acquiring tools, establishing alibis, and mapping out escape routes. The level of detail reflects the perpetrator\'s sophistication and intent.</p><p><strong>INDICATORS:</strong> Research into criminal techniques, acquisition of specific weapons or tools, changes in routine, creation of false identities, and pre-crime visits to locations.</p>' },
            { id: 'box-4', arrow: 'arrow-3-6', description: '<h2>STAGE 4: PSYCHOLOGICAL STATE</h2><p><strong>ANALYSIS:</strong> Examination of the perpetrator\'s mental and emotional condition leading up to the offense. This can include escalating psychopathy, extreme stress, delusional thinking, or a detachment from reality.</p><p><strong>INDICATORS:</strong> Increased isolation, erratic behavior, heightened anxiety, obsessive thoughts, sudden shifts in personality, or a marked lack of empathy.</p>' },
            { id: 'box-5', arrow: 'arrow-4-5', description: '<h2>STAGE 5: EXECUTION PRE-MEDITATION</h2><p><strong>ANALYSIS:</strong> The final mental preparations before the act. This often involves rituals, mental rehearsals, or a "point of no return" where the decision to commit the crime becomes immutable, overriding any lingering hesitation.</p><p><strong>INDICATORS:</strong> Final checks of equipment, deep concentration, a sense of calm or exhilaration, or a brief period of intense internal struggle followed by resolution.</p>' },
            { id: 'box-6', arrow: 'arrow-5-6', description: '<h2>STAGE 6: ACT / OFFENSE</h2><p><strong>ANALYSIS:</strong> The actual perpetration of the crime. This phase records the methodology, intensity, and any deviations from the plan. It\'s the most critical stage for evidence collection and forensic psychology.</p><p><strong>INDICATORS:</strong> Direct evidence of the crime, victim reports, witness testimonies, forensic data (DNA, fingerprints), and the immediate behavioral responses of the perpetrator.</p>' },
            { id: 'box-7', arrow: 'arrow-6-9', description: '<h2>STAGE 7: AFTERMATH / COVER-UP</h2><p><strong>ANALYSIS:</strong> Actions taken immediately following the crime to evade detection. This includes disposing of evidence, establishing an alibi, fleeing the scene, or manipulating initial accounts.</p><p><strong>INDICATORS:</strong> Rapid departure from the scene, destruction of evidence, contacting accomplices, creating false narratives, or seeking immediate psychological distancing from the act.</p>' },
            { id: 'box-8', arrow: 'arrow-7-8', description: '<h2>STAGE 8: INVESTIGATION / CONSEQUENCE</h2><p><strong>ANALYSIS:</strong> The period where law enforcement and forensic teams piece together the crime. This stage also covers the psychological toll on the perpetrator (if not apprehended) or their reaction to the investigation.</p><p><strong>INDICATORS:</strong> Forensic analysis results, witness interviews, profiler reports, media attention, and for the perpetrator, signs of paranoia, arrogance, or continued compulsive behavior.</p>' },
            { id: 'box-9', arrow: 'arrow-8-9', description: '<h2>STAGE 9: RESOLUTION / FATE</h2><p><strong>ANALYSIS:</strong> The ultimate outcome for the perpetrator – apprehension, successful evasion, or psychological breakdown. It examines how the criminal narrative concludes for the individual and for society.</p><p><strong>INDICATORS:</strong> Arrest and trial, disappearance, a repeat offense cycle, or in rare cases, self-surrender or psychological collapse leading to confession.</p>' },
        ];

        let currentStep = 0;
        const totalSteps = flowchartBoxes.length - 1;

        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const profilerNotesText = document.getElementById('profiler-notes-text');
        const currentStepNumber = document.getElementById('currentStepNumber');
        const totalStepsNumber = document.getElementById('totalStepsNumber');
        const arrowheadPolygon = document.querySelector('#arrowhead .arrowhead-polygon');

        totalStepsNumber.textContent = totalSteps;

        // Function to reset all animations and dynamic styles
        function resetAnimations() {
            document.querySelectorAll('.box-icon svg *').forEach(el => {
                el.style.animation = '';
                el.style.filter = '';
                el.style.transform = '';
            });

            // Specific opacity/visibility resets for elements that are hidden by default or fade in
            document.getElementById('q-mark').style.opacity = 0;
            document.getElementById('scan-line').style.opacity = 0;
            document.getElementById('countdown-digit').textContent = '3'; // Reset countdown
            document.getElementById('fragment-1').style.opacity = 0;
            document.getElementById('fragment-2').style.opacity = 0;
            document.getElementById('fragment-3').style.opacity = 0;
            document.getElementById('data-fragment-1').style.opacity = 0;
            document.getElementById('data-fragment-2').style.opacity = 0;
            document.getElementById('trail-path').style.strokeDashoffset = '0';
        }

        function updateFlowchart() {
            // Remove highlight from all boxes and arrows first
            document.querySelectorAll('.flow-box').forEach(box => box.classList.remove('highlight'));
            document.querySelectorAll('.flow-arrow').forEach(arrow => {
                arrow.classList.remove('highlight');
                arrow.style.stroke = 'var(--text-medium)';
            });
            // Reset arrowhead color
            arrowheadPolygon.style.fill = 'var(--text-medium)';

            // Reset all icon animations before applying new ones
            resetAnimations();

            currentStepNumber.textContent = currentStep;

            if (currentStep === 0) {
                profilerNotesText.innerHTML = '<p>Welcome to the Criminal Psychology Protocol Dashboard. Utilize the navigation controls below to step through the stages of criminal behavior and profiling. Each step will update this panel with detailed insights.</p><p>Click "Next Step" to begin.</p>';
            } else {
                const currentPhase = flowchartBoxes[currentStep];
                // Highlight the current box
                const currentBox = document.getElementById(currentPhase.id);
                currentBox.classList.add('highlight');
                
                // Highlight the arrow *leading to* this step (if defined)
                if (currentPhase.arrow) {
                    const arrowElement = document.getElementById(currentPhase.arrow);
                    arrowElement.classList.add('highlight');
                    arrowElement.style.stroke = 'var(--glow-red)'; // Set arrow color
                    arrowheadPolygon.style.fill = 'var(--glow-red)'; // Set arrowhead color
                }
                profilerNotesText.innerHTML = currentPhase.description;

                // Trigger specific animations for the highlighted box's icon
                switch(currentPhase.id) {
                    case 'box-1':
                        document.getElementById('q-mark').style.opacity = 1;
                        break;
                    case 'box-2':
                        document.getElementById('scan-line').style.opacity = 1;
                        break;
                    case 'box-3':
                        // Animation controlled by CSS class highlight
                        break;
                    case 'box-4':
                        // Animation controlled by CSS class highlight
                        break;
                    case 'box-5':
                        const countdownDigit = document.getElementById('countdown-digit');
                        let count = 3;
                        countdownDigit.textContent = count;
                        const countdownInterval = setInterval(() => {
                            count--;
                            if (count >= 0) {
                                countdownDigit.textContent = count;
                            } else {
                                clearInterval(countdownInterval);
                                countdownDigit.textContent = '0'; // Ensure it ends on 0
                            }
                        }, 1000); // Change every 1 second
                        // Clear previous interval if switching steps quickly
                        if (currentBox.dataset.countdownInterval) {
                            clearInterval(parseInt(currentBox.dataset.countdownInterval));
                        }
                        currentBox.dataset.countdownInterval = countdownInterval.toString();
                        break;
                    case 'box-6':
                        document.getElementById('fragment-1').style.opacity = 1;
                        document.getElementById('fragment-2').style.opacity = 1;
                        document.getElementById('fragment-3').style.opacity = 1;
                        break;
                    case 'box-7':
                        // Animation controlled by CSS class highlight
                        break;
                    case 'box-8':
                        document.getElementById('data-fragment-1').style.opacity = 1;
                        document.getElementById('data-fragment-2').style.opacity = 1;
                        break;
                    case 'box-9':
                        // Animation controlled by CSS class highlight
                        break;
                }
            }

            // Update button states
            prevBtn.disabled = currentStep === 0;
            nextBtn.disabled = currentStep === totalSteps;
        }

        nextBtn.addEventListener('click', () => {
            if (currentStep < totalSteps) {
                currentStep++;
                updateFlowchart();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                updateFlowchart();
            }
        });

        document.addEventListener('DOMContentLoaded', updateFlowchart);
    </script>
</body>
</html>
